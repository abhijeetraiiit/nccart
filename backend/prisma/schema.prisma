// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: For PostGIS support, use:
// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
//   extensions = [postgis]
// }
// And ensure PostGIS extension is installed: CREATE EXTENSION IF NOT EXISTS postgis;

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  CUSTOMER
  SELLER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  phone         String?     @unique
  password      String
  role          UserRole    @default(CUSTOMER)
  status        UserStatus  @default(PENDING_VERIFICATION)
  emailVerified Boolean     @default(false)
  phoneVerified Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  customer      Customer?
  seller        Seller?
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  wishlists     Wishlist[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
}

model Customer {
  id               String   @id @default(uuid())
  userId           String   @unique
  firstName        String
  lastName         String
  avatar           String?
  
  // Buyer Trust Score fields
  totalOrders      Int      @default(0)
  returnedOrders   Int      @default(0)
  cancelledOrders  Int      @default(0)
  trustScore       Float    @default(0.5)
  lastScoreUpdate  DateTime @default(now())
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([trustScore])
}

// ============================================
// SELLER MANAGEMENT
// ============================================

enum SellerType {
  INDIVIDUAL
  BUSINESS
}

enum SellerStatus {
  PENDING_APPROVAL
  ACTIVE
  SUSPENDED
  REJECTED
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

model Seller {
  id                String        @id @default(uuid())
  userId            String        @unique
  businessName      String
  displayName       String
  description       String?
  logo              String?
  type              SellerType    @default(INDIVIDUAL)
  status            SellerStatus  @default(PENDING_APPROVAL)
  
  // KYC Information
  kycStatus         KYCStatus     @default(NOT_SUBMITTED)
  panNumber         String?       @unique
  panDocument       String?
  aadhaarNumber     String?       @unique
  aadhaarDocument   String?
  gstNumber         String?       @unique
  gstCertificate    String?
  fssaiLicense      String?
  
  // Business Details
  businessAddress   String?
  pickupAddress     String?
  bankAccountNumber String?
  bankIfscCode      String?
  bankAccountHolder String?
  
  // Trial & Fees
  trialStartDate    DateTime      @default(now())
  trialEndDate      DateTime
  isTrialActive     Boolean       @default(true)
  platformFeesPaid  Float         @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  products          Product[]
  orders            OrderItem[]
  analytics         SellerAnalytics?
  
  @@index([userId])
  @@index([status])
  @@index([kycStatus])
}

model SellerAnalytics {
  id              String   @id @default(uuid())
  sellerId        String   @unique
  totalProducts   Int      @default(0)
  totalOrders     Int      @default(0)
  totalRevenue    Float    @default(0)
  totalPlatformFees Float  @default(0)
  rating          Float?
  totalReviews    Int      @default(0)
  updatedAt       DateTime @updatedAt
  
  seller          Seller   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
}

// ============================================
// PRODUCT CATALOG
// ============================================

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

model Category {
  id          String      @id @default(uuid())
  name        String      @unique
  slug        String      @unique
  description String?
  image       String?
  parentId    String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  parent      Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]  @relation("CategoryHierarchy")
  products    Product[]
  
  @@index([slug])
  @@index([parentId])
}

model Product {
  id              String          @id @default(uuid())
  sellerId        String
  categoryId      String
  name            String
  slug            String          @unique
  description     String
  shortDescription String?
  
  // Pricing
  price           Float
  mrp             Float
  discount        Float           @default(0)
  
  // Inventory
  sku             String          @unique
  stock           Int             @default(0)
  lowStockAlert   Int             @default(10)
  
  // Details
  images          String[]
  specifications  Json?
  countryOfOrigin String          @default("India")
  hsn             String?
  weight          Float?          // in kg
  dimensions      Json?           // {length, width, height} in cm
  
  status          ProductStatus   @default(DRAFT)
  isFeatured      Boolean         @default(false)
  viewCount       Int             @default(0)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  seller          Seller          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category        Category        @relation(fields: [categoryId], references: [id])
  reviews         Review[]
  orderItems      OrderItem[]
  wishlists       Wishlist[]
  
  @@index([sellerId])
  @@index([categoryId])
  @@index([slug])
  @@index([status])
  @@index([name])
}

// ============================================
// ORDERS & PAYMENTS
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  UPI
  CARD
  NETBANKING
  WALLET
  COD
  COD_WITH_DEPOSIT
  BNPL
}

model Order {
  id                String          @id @default(uuid())
  userId            String
  orderNumber       String          @unique
  
  // Address
  shippingAddressId String
  billingAddressId  String
  
  // Pricing
  subtotal          Float
  deliveryCharge    Float
  tax               Float
  discount          Float           @default(0)
  total             Float
  commitmentFee     Float           @default(0)
  
  // Payment
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus   @default(PENDING)
  paymentId         String?
  
  // Status
  status            OrderStatus     @default(PENDING)
  
  // Delivery
  deliveryPartner      String?
  deliveryPartnerId    String?
  trackingNumber       String?
  estimatedDelivery    DateTime?
  deliveredAt          DateTime?
  
  // Delivery location coordinates
  deliveryLatitude     Float?
  deliveryLongitude    Float?
  pickupLatitude       Float?
  pickupLongitude      Float?
  
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  
  user                 User            @relation(fields: [userId], references: [id])
  shippingAddress      Address         @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress       Address         @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items                OrderItem[]
  partner              DeliveryPartner? @relation("PartnerDeliveries", fields: [deliveryPartnerId], references: [id])
  
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([deliveryPartnerId])
}

model OrderItem {
  id          String      @id @default(uuid())
  orderId     String
  productId   String
  sellerId    String
  
  quantity    Int
  price       Float       // Price at time of order
  discount    Float       @default(0)
  tax         Float
  subtotal    Float
  
  createdAt   DateTime    @default(now())
  
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])
  seller      Seller      @relation(fields: [sellerId], references: [id])
  
  @@index([orderId])
  @@index([productId])
  @@index([sellerId])
}

// ============================================
// ADDRESSES
// ============================================

enum AddressType {
  HOME
  WORK
  OTHER
}

model Address {
  id          String      @id @default(uuid())
  userId      String
  type        AddressType @default(HOME)
  
  fullName    String
  phone       String
  addressLine1 String
  addressLine2 String?
  landmark    String?
  city        String
  state       String
  pincode     String
  country     String      @default("India")
  
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders Order[]  @relation("ShippingAddress")
  billingOrders  Order[]  @relation("BillingAddress")
  
  @@index([userId])
  @@index([pincode])
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id          String   @id @default(uuid())
  userId      String
  productId   String
  
  rating      Int      // 1-5
  title       String?
  comment     String
  images      String[]
  
  isVerified  Boolean  @default(false)
  helpfulCount Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
  @@index([productId])
  @@index([rating])
}

// ============================================
// WISHLIST
// ============================================

model Wishlist {
  id          String   @id @default(uuid())
  userId      String
  productId   String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
  @@index([userId])
}

// ============================================
// DELIVERY PARTNERS & ELASTIC LOGISTICS MESH
// ============================================

enum DeliveryPartnerStatus {
  ACTIVE
  INACTIVE
}

enum PartnerType {
  WALKER
  BIKE
  EV
  NATIONAL_COURIER
}

enum KYCVerificationStatus {
  NOT_VERIFIED
  PENDING
  VERIFIED
  REJECTED
}

// Individual delivery partners (Walkers, Gig workers)
model DeliveryPartner {
  id              String                @id @default(uuid())
  name            String
  phone           String                @unique
  email           String?
  
  // Partner Type
  partnerType     PartnerType           @default(WALKER)
  status          DeliveryPartnerStatus @default(INACTIVE)
  
  // KYC Information
  aadhaarNumber   String?               @unique
  aadhaarDocument String?
  aadhaarVerified Boolean               @default(false)
  kycStatus       KYCVerificationStatus @default(NOT_VERIFIED)
  
  // Location (stored as separate Float fields for lat/lon)
  // In production with PostGIS: Use GEOGRAPHY(POINT, 4326) type
  currentLatitude  Float?
  currentLongitude Float?
  lastLocationUpdate DateTime?
  
  // Availability
  isAvailable     Boolean               @default(false)
  availableFrom   DateTime?
  availableTo     DateTime?
  
  // Performance metrics
  rating          Float                 @default(0)
  totalDeliveries Int                   @default(0)
  successfulDeliveries Int              @default(0)
  totalEarnings   Float                 @default(0)
  
  // Gamification
  badges          String[]              @default([])
  level           Int                   @default(1)
  
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Relations
  dispatchLogs    DispatchLog[]
  deliveries      Order[]               @relation("PartnerDeliveries")
  
  @@index([phone])
  @@index([partnerType])
  @@index([status])
  @@index([isAvailable])
  @@index([currentLatitude, currentLongitude])
}

// National courier partners (Delhivery, Shiprocket, etc.)
model CourierPartner {
  id                String                @id @default(uuid())
  name              String                @unique
  displayName       String
  logo              String?
  apiKey            String?
  apiSecret         String?
  webhookUrl        String?
  status            DeliveryPartnerStatus @default(ACTIVE)
  
  // Performance metrics
  averageRating     Float                 @default(0)
  successRate       Float                 @default(100)
  
  // Pricing weight (for algorithm)
  priceWeight       Float                 @default(0.5)
  speedWeight       Float                 @default(0.3)
  reliabilityWeight Float                 @default(0.2)
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([status])
}

// Dispatch logs for smart dispatch tracking
enum DispatchStage {
  MESH           // Stage 1: Neighborhood walkers
  GIG            // Stage 2: Gig pool (bike/EV)
  COURIER        // Stage 3: National courier
}

model DispatchLog {
  id                   String         @id @default(uuid())
  orderId              String
  partnerId            String?
  
  // Dispatch details
  stage                DispatchStage
  pingedAt             DateTime       @default(now())
  respondedAt          DateTime?
  accepted             Boolean        @default(false)
  responseTimeSeconds  Int?
  
  // Location at ping time
  vendorLatitude       Float?
  vendorLongitude      Float?
  customerLatitude     Float?
  customerLongitude    Float?
  distanceKm           Float?
  
  createdAt            DateTime       @default(now())
  
  // Relations
  partner              DeliveryPartner? @relation(fields: [partnerId], references: [id])
  
  @@index([orderId])
  @@index([partnerId])
  @@index([stage])
  @@index([accepted])
  @@index([pingedAt])
}

// Pincode risk mapping for RTO prevention
model PincodeRisk {
  id              String   @id @default(uuid())
  pincode         String   @unique
  
  // Risk metrics
  riskScore       Float    @default(0.5)  // 0 (Safe) to 1 (High Risk)
  totalOrders     Int      @default(0)
  returnedOrders  Int      @default(0)
  cancelledOrders Int      @default(0)
  
  // Location info
  city            String?
  state           String?
  region          String?
  
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  
  @@index([pincode])
  @@index([riskScore])
}

// Vendor inventory with location
model VendorInventory {
  id               String   @id @default(uuid())
  vendorId         String
  productId        String
  
  // Inventory
  quantity         Int
  lowStockAlert    Int      @default(10)
  
  // Shop location (for geospatial queries)
  shopLatitude     Float?
  shopLongitude    Float?
  shopAddress      String?
  
  lastUpdated      DateTime @default(now())
  createdAt        DateTime @default(now())
  
  @@unique([vendorId, productId])
  @@index([vendorId])
  @@index([productId])
  @@index([shopLatitude, shopLongitude])
}

// ============================================
// PLATFORM SETTINGS
// ============================================

model PlatformSettings {
  id                  String   @id @default(uuid())
  key                 String   @unique
  value               String
  description         String?
  updatedAt           DateTime @updatedAt
  
  @@index([key])
}
